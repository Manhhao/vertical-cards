<div id="dictname">{{DictionaryName}}</div>

<div id="container">
    <div id="header-container">
        <div id="expression">{{Word}}</div>
        <div id="reading">{{Reading}}</div>
    </div>

    <div id="content-container">
        <div id="glossary-container">
            <div id="definition">{{Glossary}}</div>
            <div id="sentence">{{Sentence}}</div>
        </div>

        <div id="image-container">
            <div id="image">{{Picture}}</div>
        </div>
    </div>
</div>

{{Audio}} {{SentenceAudio}}

<script>
    (function () {
        window.dictionaryContext = {
            cssFiles: {
                "三省堂 全訳読解古語辞典": "_skogo_anki.css",
                "旺文社 全訳古語辞典": "_ozk5_anki.css",
                "角川新字源 改訂新版": "_shinjigen_anki.css",
                "明鏡国語辞典 第三版": "_meikyo_anki.css"
            },

            collapsibleSelectors: {
                "三省堂 全訳読解古語辞典": [
                    "div[data-sc絵巻項目]",
                    "div[data-sc読解-g]"
                ],
                "旺文社 全訳古語辞典": [
                    "div[data-sc用例囲み-g]",
                    "div[data-sc発展]"
                ]
            },

            displayNameMap: {
                // 三省堂 全訳読解古語辞典
                "絵巻項目": "絵巻",
                "発展": "発展事項",
                "読解-g": "読解",

                // 旺文社 全訳古語辞典
                "用例囲み-g": "例文・訳"
            },

            imageSelectors: {
                "三省堂 全訳読解古語辞典": "div[data-sc画像-g]",
                "大辞泉 第二版": "div[data-sc-m-image]",

                // Default selectors
                "default": "div[data-sc画像-g], .image-container, .figure, figure, .img-container"
            },

            activeDictionaries: {},
            isVertical: false,

            init: function () {
                this.isVertical = window.getComputedStyle(document.body).writingMode === 'vertical-rl';

                // Find all dictionary entries and track which ones are present
                document.querySelectorAll("li[data-dictionary]").forEach((entry) => {
                    const dictName = entry.getAttribute("data-dictionary");
                    if (dictName) {
                        this.activeDictionaries[dictName] = true;
                    }
                });

                // If no dictionaries found in list items, check the DictionaryName field
                if (Object.keys(this.activeDictionaries).length === 0) {
                    const dictionaryNameElement = document.getElementById("dictname");
                    if (dictionaryNameElement) {
                        const dictionaryName = dictionaryNameElement.textContent.trim();
                        if (dictionaryName) {
                            this.activeDictionaries[dictionaryName] = true;
                        }
                    }
                }

                console.log("Active dictionaries:", Object.keys(this.activeDictionaries));
            }
        };

        window.dictionaryContext.init();
    })();

    // Hide sentence field if empty
    (function () {
        var sentenceDiv = document.getElementById("sentence");
        if (sentenceDiv && sentenceDiv.textContent.trim() === "") {
            sentenceDiv.style.display = "none";
        }
    })();

    // Hide reading and sentence if same as term
    (function () {
        var expresssionDiv = document.getElementById("expression");
        var readingDiv = document.getElementById("reading");
        var sentenceDiv = document.getElementById("sentence")
        if (expresssionDiv && readingDiv &&
            expresssionDiv.textContent.trim() === readingDiv.textContent.trim()) {
            readingDiv.style.display = "none";
        }

        if (expresssionDiv && sentenceDiv &&
            expresssionDiv.textContent.trim() === sentenceDiv.textContent.trim()) {
            sentenceDiv.style.display = "none"
        }
    })();

    // Load dictionary CSS files
    (function () {
        const { cssFiles, activeDictionaries } = window.dictionaryContext;

        // Load CSS for active dictionaries
        Object.keys(activeDictionaries).forEach(dictionaryName => {
            if (cssFiles[dictionaryName]) {
                const link = document.createElement("link");
                link.rel = "stylesheet";
                link.href = cssFiles[dictionaryName];
                document.head.appendChild(link);
                console.log(`Loaded CSS for dictionary: ${dictionaryName}`);
            }
        });
    })();


    /* Cyclable definitions script */
    (function () {
        var definitionContainer = document.getElementById("definition");

        if (!definitionContainer) return;

        var definitionItems = definitionContainer.querySelectorAll("li");

        // If there are multiple definitions
        if (definitionItems.length > 1) {
            var counterElement = document.createElement("div");
            counterElement.className = "definition-counter";

            // Add left and right edges for clicking
            var leftEdge = document.createElement("div");
            var rightEdge = document.createElement("div");

            leftEdge.className = "definition-left-edge";
            rightEdge.className = "definition-right-edge";

            // Function to adjust position based on orientation
            function adjustPositions() {
                const isVertical = window.dictionaryContext &&
                    window.dictionaryContext.isVertical;

                // Add or remove vertical class for CSS-based positioning
                const containerToUse = document.getElementById("content-container") || definitionContainer;

                if (isVertical) {
                    containerToUse.classList.add("vertical-mode");
                } else {
                    containerToUse.classList.remove("vertical-mode");
                }
            }

            function setupElements() {
                const contentContainer = document.getElementById("content-container");
                const containerToUse = contentContainer || definitionContainer;

                containerToUse.style.position = "relative";
                containerToUse.appendChild(counterElement);
                containerToUse.appendChild(leftEdge);
                containerToUse.appendChild(rightEdge);

                adjustPositions();
            }

            setupElements();

            window.addEventListener("resize", function () {
                if (window.dictionaryContext) {
                    window.dictionaryContext.isVertical =
                        window.getComputedStyle(document.body).writingMode === 'vertical-rl';
                }

                adjustPositions();
            });

            let currentIndex = 0;

            // Hide all definitions except the first one
            for (let i = 1; i < definitionItems.length; i++) {
                definitionItems[i].style.display = "none";
            }

            function updateCounter() {
                counterElement.textContent = `${currentIndex + 1}/${definitionItems.length}`;
            }

            updateCounter();

            // Function to cycle to the next definition
            function cycleDefinition(direction) {
                definitionItems[currentIndex].style.display = "none";

                // Calculate new index with wraparound
                if (direction === "next") {
                    currentIndex = (currentIndex + 1) % definitionItems.length;
                } else {
                    currentIndex = (currentIndex - 1 + definitionItems.length) % definitionItems.length;
                }

                definitionItems[currentIndex].style.display = "";
                updateCounter();
            }

            // Add click events to the edges
            leftEdge.addEventListener("click", function () {
                cycleDefinition("prev");
            });

            rightEdge.addEventListener("click", function () {
                cycleDefinition("next");
            });

            // Function to handle arrow key navigation
            function handleArrowKeys(event) {
                if (event.key === "ArrowLeft" || event.keyCode === 37) {
                    cycleDefinition("prev");
                } else if (event.key === "ArrowRight" || event.keyCode === 39) {
                    cycleDefinition("next");
                }
            }

            document.addEventListener("keydown", handleArrowKeys);

            setTimeout(adjustPositions, 300);
        }
    })();


    // Script to make specific elements collapsible in dictionary entries
    (function () {
        const { collapsibleSelectors, displayNameMap, activeDictionaries } = window.dictionaryContext;

        // Check if we're in vertical mode and add class to body
        function detectVerticalMode() {
            const isVertical = window.getComputedStyle(document.body).writingMode === 'vertical-rl';
            document.body.classList.toggle('vertical-mode', isVertical);
            return isVertical;
        }

        function processElementsWithSelectors(container, selectors) {
            selectors.forEach(selector => {
                const elements = container.querySelectorAll(selector);

                elements.forEach(element => {
                    if (element.parentNode && element.parentNode.classList &&
                        element.parentNode.classList.contains('collapsible-content')) {
                        return;
                    }

                    const attrMatch = selector.match(/data-sc([^=\]]*)/);
                    const rawAttrName = attrMatch ? attrMatch[1] : selector.split('[')[1].split(']')[0];

                    const displayName = displayNameMap[rawAttrName] || rawAttrName;

                    const wrapper = document.createElement('div');
                    wrapper.className = 'collapsible-wrapper collapsed';

                    const header = document.createElement('div');
                    header.className = 'collapsible-header';
                    header.textContent = displayName;

                    const content = document.createElement('div');
                    content.className = 'collapsible-content';

                    element.parentNode.insertBefore(wrapper, element);
                    wrapper.appendChild(header);
                    wrapper.appendChild(content);
                    content.appendChild(element);

                    header.addEventListener('click', function (e) {
                        e.stopPropagation();
                        wrapper.classList.toggle('collapsed');
                    });
                });
            });
        }

        function forceRedraw() {
            document.querySelectorAll('.collapsible-wrapper').forEach(wrapper => {
                wrapper.classList.add('force-redraw');
                setTimeout(() => wrapper.classList.remove('force-redraw'), 10);
            });
        }

        function init() {
            // Check for vertical mode FIRST
            detectVerticalMode();

            const dictionariesToProcess = Object.keys(activeDictionaries);

            // If no specific dictionaries found in list items, check the DictionaryName field
            if (dictionariesToProcess.length === 0) {
                const dictionaryNameElement = document.getElementById("dictname");
                if (dictionaryNameElement && dictionaryNameElement.textContent.trim()) {
                    const singleDictName = dictionaryNameElement.textContent.trim();
                    if (collapsibleSelectors[singleDictName]) {
                        dictionariesToProcess.push(singleDictName);
                    }
                }
            }

            dictionariesToProcess.forEach(dictionaryName => {
                if (!collapsibleSelectors[dictionaryName]) return;

                const currentSelectors = collapsibleSelectors[dictionaryName];

                const entries = document.querySelectorAll(`li[data-dictionary="${dictionaryName}"]`);

                if (entries.length > 0) {
                    entries.forEach(entry => {
                        processElementsWithSelectors(entry, currentSelectors);
                    });
                }
                // Process single dictionary case
                else {
                    processElementsWithSelectors(document, currentSelectors);
                }
            });

            forceRedraw();
        }

        function setupEventListeners() {
            let resizeTimer;
            window.addEventListener('resize', function () {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function () {
                    detectVerticalMode();
                    forceRedraw();
                }, 250);
            });

            document.addEventListener('DOMContentLoaded', function () {
                detectVerticalMode();
                forceRedraw();
            });
        }

        if (document.readyState === 'interactive' || document.readyState === 'complete') {
            detectVerticalMode();
        }

        init();
        setupEventListeners();

        setTimeout(function () {
            detectVerticalMode();
            forceRedraw();
        }, 50);
    })();


    // Script to show only the first image in dictionary entries
    (function () {
        const { imageSelectors, activeDictionaries } = window.dictionaryContext;
        if (!Object.keys(activeDictionaries).length) return;

        function hideExtraImages(container, selector) {
            const images = container.querySelectorAll(selector);
            if (images.length > 1) {
                images.forEach((img, idx) => {
                    if (idx > 0) img.style.display = "none";
                });
            }
        }

        // Handle <li> dictionary entries
        for (const dictName of Object.keys(activeDictionaries)) {
            const selector = imageSelectors[dictName] || imageSelectors["default"];
            document.querySelectorAll(`li[data-dictionary="${dictName}"]`)
                .forEach(entry => hideExtraImages(entry, selector));
        }

        // Handle single dictionary entry layout
        const dictnameEl = document.getElementById("dictname");
        if (dictnameEl) {
            const singleDict = dictnameEl.textContent.trim();
            if (activeDictionaries[singleDict]) {
                const selector = imageSelectors[singleDict] || imageSelectors["default"];
                hideExtraImages(document, selector);
            }
        }
    })();
</script>